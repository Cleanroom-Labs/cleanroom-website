name: Build All Documentation

on:
  push:
    branches: [main]
    paths:
      - 'technical-docs/**'
      - 'scripts/**'
      - '.github/workflows/build-all-docs.yml'
  pull_request:
    branches: [main]
    paths:
      - 'technical-docs/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.SUBMODULE_PAT }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'

    - name: Install Graphviz
      run: sudo apt-get update && sudo apt-get install -y graphviz

    - name: Install Python dependencies
      run: |
        cd technical-docs
        pip install -r requirements.txt

    - name: Build all documentation
      run: |
        cd technical-docs
        make html

    - name: Check for build warnings
      run: |
        cd technical-docs
        make html-check

    - name: Copy built docs to public directory
      run: |
        echo "Copying built documentation to public/docs/..."

        # Create public/docs if it doesn't exist
        mkdir -p public/docs

        # Copy master docs
        cp -r technical-docs/build/html/* public/docs/

        # Optionally copy individual project docs
        # (useful if you want direct links to project docs)
        # mkdir -p public/docs/projects
        # cp -r technical-docs/whisper/build/html public/docs/projects/whisper
        # cp -r technical-docs/deploy/build/html public/docs/projects/deploy
        # cp -r technical-docs/transfer/build/html public/docs/projects/transfer

        echo "‚úì Documentation copied to public/docs/"

    - name: Verify build output
      run: |
        echo "## Build Output Verification"
        echo ""

        # Check that key files exist
        if [ ! -f public/docs/index.html ]; then
          echo "‚ùå ERROR: Master index.html not found"
          exit 1
        fi

        if [ ! -f public/docs/projects/whisper.html ]; then
          echo "‚ö†Ô∏è  WARNING: Whisper stub page not found"
        fi

        if [ ! -f public/docs/projects/deploy.html ]; then
          echo "‚ö†Ô∏è  WARNING: Deploy stub page not found"
        fi

        if [ ! -f public/docs/projects/transfer.html ]; then
          echo "‚ö†Ô∏è  WARNING: Transfer stub page not found"
        fi

        # Show directory structure
        echo ""
        echo "Built documentation structure:"
        tree -L 2 public/docs || ls -la public/docs

        echo ""
        echo "‚úì Build verification complete"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: public/docs
        retention-days: 30

    - name: Generate build summary
      run: |
        echo "# üìö Documentation Build Summary"
        echo ""
        echo "‚úì All documentation built successfully"
        echo ""
        echo "## Projects Built"
        echo "- Cleanroom Whisper"
        echo "- AirGap Deploy"
        echo "- AirGap Transfer"
        echo "- Master documentation"
        echo ""
        echo "## Output"
        echo "Built documentation available in artifacts (retention: 30 days)"
